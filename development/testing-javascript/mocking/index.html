<!doctype html><html lang=en><head><meta charset=utf-8><meta name=description content="Mocking is used to enable testing modules that depend (as in dependency) on another modules, that we don&rsquo;t want to really use, e."><title>Mocking</title><meta name=viewport content="width=device-width,initial-scale=1"><link rel="shortcut icon" type=image/png href=https://koscielniak.pro/icon.png><link href=https://koscielniak.pro/styles.9795826ea4fa61978dfd826a4365a859.min.css rel=stylesheet><link href=https://koscielniak.pro/styles/_light_syntax.86a48a52faebeaaf42158b72922b1c90.min.css rel=stylesheet id=theme-link><script src=https://koscielniak.pro/js/darkmode.65e02719d0d9967e13e7b6186bd55800.min.js></script>
<script src=https://koscielniak.pro/js/util.5e39932758f9ecaf45fd54506ed61416.min.js></script>
<link rel=stylesheet href=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.css integrity=sha384-R4558gYOUz8mP9YWpZJjofhk+zx0AS11p36HnD2ZKj/6JR5z27gSSULCNHIRReVs crossorigin=anonymous><script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/katex.min.js integrity=sha384-z1fJDqw8ZApjGO3/unPWUPsIymfsJmyrDVWC8Tv/a1HeOtGmkwNd/7xUS0Xcnvsx crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.15.1/dist/contrib/auto-render.min.js integrity=sha384-+XBljXPPiv+OzfbB3cVmLHf4hdUFHlWNZN5spNQ7rmHTXpd7WvJum6fIACpNNfIR crossorigin=anonymous></script>
<script defer src=https://cdn.jsdelivr.net/npm/katex@0.16.2/dist/contrib/copy-tex.min.js integrity=sha384-ww/583aHhxWkz5DEVn6OKtNiIaLi2iBRNZXfJRiY1Ai7tnJ9UXpEsyvOITVpTl4A crossorigin=anonymous></script>
<script src=https://unpkg.com/@floating-ui/core@0.7.3></script>
<script src=https://unpkg.com/@floating-ui/dom@0.5.4></script>
<script src=https://koscielniak.pro/js/popover.6da9b273c092cc16fc1aa904d71a2163.min.js></script>
<script src=https://koscielniak.pro/js/code-title.b35124ad8db0ba37162b886afb711cbc.min.js></script>
<script src=https://koscielniak.pro/js/clipboard.c20857734e53a3fb733b7443879efa61.min.js></script>
<script src=https://koscielniak.pro/js/callouts.7723cac461d613d118ee8bb8216b9838.min.js></script>
<script>const SEARCH_ENABLED=!1,LATEX_ENABLED=!0,PRODUCTION=!0,BASE_URL="https://koscielniak.pro",fetchData=Promise.all([fetch("https://koscielniak.pro/indices/linkIndex.f819bd7dd0024b542a603650656c331e.min.json").then(e=>e.json()).then(e=>({index:e.index,links:e.links})),fetch("https://koscielniak.pro/indices/contentIndex.0dc0d374ed821d62e1e4cc431b43c91d.min.json").then(e=>e.json())]).then(([{index:e,links:t},n])=>({index:e,links:t,content:n})),render=()=>{const e=new URL(BASE_URL),t=e.pathname,n=window.location.pathname,s=t==n;addCopyButtons(),addTitleToCodeBlocks(),addCollapsibleCallouts();const o=document.getElementById("footer");if(o){const e=document.getElementById("graph-container");if(!e)return requestAnimationFrame(render);e.textContent="";const t=s&&!1;drawGraph("https://koscielniak.pro",t,[{"/moc":"#4388cc"}],t?{centerForce:1,depth:-1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.5,linkDistance:1,opacityScale:3,repelForce:1,scale:1.4}:{centerForce:1,depth:1,enableDrag:!0,enableLegend:!1,enableZoom:!0,fontSize:.6,linkDistance:1,opacityScale:3,repelForce:2,scale:1.2})}var i=document.getElementsByClassName("mermaid");i.length>0&&import("https://unpkg.com/mermaid@9/dist/mermaid.esm.min.mjs").then(e=>{e.default.init()})},init=(e=document)=>{addCopyButtons(),addTitleToCodeBlocks(),renderMathInElement(e.body,{delimiters:[{left:"$$",right:"$$",display:!0},{left:"$",right:"$",display:!1}],macros:{'‚Äô':"'"},throwOnError:!1})}</script><script type=module>
    import { attachSPARouting } from "https:\/\/koscielniak.pro\/js\/router.9d4974281069e9ebb189f642ae1e3ca2.min.js"
    attachSPARouting(init, render)
  </script></head><body><div id=search-container><div id=search-space><input autocomplete=off id=search-bar name=search type=text aria-label=Search placeholder="Search for something..."><div id=results-container></div></div></div><script src=https://cdn.jsdelivr.net/npm/flexsearch@0.7.21/dist/flexsearch.bundle.js integrity="sha256-i3A0NZGkhsKjVMzFxv3ksk0DZh3aXqu0l49Bbh0MdjE=" crossorigin=anonymous defer></script>
<script defer src=https://koscielniak.pro/js/full-text-search.51f0b1753e9b30839d053f8a98cc20d1.min.js></script><div class=singlePage><header><h1 id=page-title><a href=https://koscielniak.pro>üçç koscielniak.pro</a></h1><div class=spacer></div><div id=search-icon><p>‚åò+K</p><svg tabindex="0" aria-labelledby="title desc" role="img" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 19.9 19.7"><title id="title">Search Icon</title><desc id="desc">Icon to open search</desc><g class="search-path" fill="none"><path stroke-linecap="square" d="M18.5 18.3l-5.4-5.4"/><circle cx="8" cy="8" r="7"/></g></svg></div><div class=darkmode><input class=toggle id=darkmode-toggle type=checkbox tabindex=-1>
<label id=toggle-label-light for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="dayIcon" viewBox="0 0 35 35" style="enable-background:new 0 0 35 35"><title>Light Mode</title><path d="M6 17.5C6 16.672 5.328 16 4.5 16h-3C.672 16 0 16.672.0 17.5S.672 19 1.5 19h3C5.328 19 6 18.328 6 17.5zM7.5 26c-.414.0-.789.168-1.061.439l-2 2C4.168 28.711 4 29.086 4 29.5 4 30.328 4.671 31 5.5 31c.414.0.789-.168 1.06-.44l2-2C8.832 28.289 9 27.914 9 27.5 9 26.672 8.329 26 7.5 26zm10-20C18.329 6 19 5.328 19 4.5v-3C19 .672 18.329.0 17.5.0S16 .672 16 1.5v3C16 5.328 16.671 6 17.5 6zm10 3c.414.0.789-.168 1.06-.439l2-2C30.832 6.289 31 5.914 31 5.5 31 4.672 30.329 4 29.5 4c-.414.0-.789.168-1.061.44l-2 2C26.168 6.711 26 7.086 26 7.5 26 8.328 26.671 9 27.5 9zM6.439 8.561C6.711 8.832 7.086 9 7.5 9 8.328 9 9 8.328 9 7.5c0-.414-.168-.789-.439-1.061l-2-2C6.289 4.168 5.914 4 5.5 4 4.672 4 4 4.672 4 5.5c0 .414.168.789.439 1.06l2 2.001zM33.5 16h-3c-.828.0-1.5.672-1.5 1.5s.672 1.5 1.5 1.5h3c.828.0 1.5-.672 1.5-1.5S34.328 16 33.5 16zM28.561 26.439C28.289 26.168 27.914 26 27.5 26c-.828.0-1.5.672-1.5 1.5.0.414.168.789.439 1.06l2 2C28.711 30.832 29.086 31 29.5 31c.828.0 1.5-.672 1.5-1.5.0-.414-.168-.789-.439-1.061l-2-2zM17.5 29c-.829.0-1.5.672-1.5 1.5v3c0 .828.671 1.5 1.5 1.5s1.5-.672 1.5-1.5v-3C19 29.672 18.329 29 17.5 29zm0-22C11.71 7 7 11.71 7 17.5S11.71 28 17.5 28 28 23.29 28 17.5 23.29 7 17.5 7zm0 18c-4.136.0-7.5-3.364-7.5-7.5s3.364-7.5 7.5-7.5 7.5 3.364 7.5 7.5S21.636 25 17.5 25z"/></svg></label><label id=toggle-label-dark for=darkmode-toggle tabindex=-1><svg xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" id="nightIcon" viewBox="0 0 100 100" style="enable-background='new 0 0 100 100'"><title>Dark Mode</title><path d="M96.76 66.458c-.853-.852-2.15-1.064-3.23-.534-6.063 2.991-12.858 4.571-19.655 4.571C62.022 70.495 50.88 65.88 42.5 57.5 29.043 44.043 25.658 23.536 34.076 6.47c.532-1.08.318-2.379-.534-3.23-.851-.852-2.15-1.064-3.23-.534-4.918 2.427-9.375 5.619-13.246 9.491-9.447 9.447-14.65 22.008-14.65 35.369.0 13.36 5.203 25.921 14.65 35.368s22.008 14.65 35.368 14.65c13.361.0 25.921-5.203 35.369-14.65 3.872-3.871 7.064-8.328 9.491-13.246C97.826 68.608 97.611 67.309 96.76 66.458z"/></svg></label></div></header><article><h1>Mocking</h1><p class=meta>Last updated
Unknown
<a href=https://github.com/kkoscielniak/the-digital-garden/development/testing-javascript/mocking.md rel=noopener>Edit Source</a></p><ul class=tags></ul><aside class=mainTOC><details><summary>Table of Contents</summary><nav id=TableOfContents><ol><li><a href=#monkey-patching>Monkey patching</a><ol><li><a href=#cleanup>Cleanup</a></li></ol></li><li><a href=#ensuring-fns-are-called-properly-with-mocks>Ensuring fns are called properly with mocks</a></li><li><a href=#jestfn><code>jest.fn</code></a></li><li><a href=#jestspyon><code>jest.spyOn</code></a></li><li><a href=#jestmock><code>jest.mock</code></a></li><li><a href=#mocking-a-module-shared-across-the-codebase>Mocking a module shared across the codebase</a></li></ol></nav></details></aside><p>Mocking is used to enable testing modules that depend (as in <em>dependency</em>) on another modules, that we don&rsquo;t want to <em>really</em> use, e.g. credit card service.</p><p>We may not want to do any requests with a credit card service, so we can mock it (btw making its behavior <a class="internal-link broken">deterministic</a>).</p><a href=#monkey-patching><h2 id=monkey-patching><span class=hanchor arialabel=Anchor># </span>Monkey patching</h2></a><p>Monkey patching is the most naive (and limited) approach to mocking in JS. Basically it&rsquo;s overriding an object property (e.g. <code>utils.getWinner()</code>) in the test.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>const</span> <span class=nx>assert</span> <span class=o>=</span> <span class=kr>require</span><span class=p>(</span><span class=s2>&#34;assert&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>thumbWawr</span> <span class=o>=</span> <span class=kr>require</span><span class=p>(</span><span class=s2>&#34;../thumbwar&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>utils</span> <span class=o>=</span> <span class=kr>require</span><span class=p>(</span><span class=s2>&#34;../utils&#34;</span><span class=p>);</span> <span class=c1>// `utils` is the module we want to mock
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>originalGetWinner</span> <span class=o>=</span> <span class=nx>utils</span><span class=p>.</span><span class=nx>getWinner</span><span class=p>;</span> <span class=c1>// saving the original implementation for cleanup
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>utils</span><span class=p>.</span><span class=nx>getWinner</span> <span class=o>=</span> <span class=p>(</span><span class=nx>p1</span><span class=p>,</span> <span class=nx>p2</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>p1</span><span class=p>;</span> <span class=c1>// here we make sure `.getWinner` will always ensure the first player wins
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=kr>const</span> <span class=nx>winner</span> <span class=o>=</span> <span class=nx>thumbWar</span><span class=p>(</span><span class=s2>&#34;Kent C. Dodds&#34;</span><span class=p>,</span> <span class=s2>&#34;Ken Wheeler&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>assert</span><span class=p>.</span><span class=nx>strictEqual</span><span class=p>(</span><span class=nx>winner</span><span class=p>,</span> <span class=s2>&#34;Kent C. Dodds&#34;</span><span class=p>);</span> <span class=c1>// PASS
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl><span class=nx>utils</span><span class=p>.</span><span class=nx>getWinner</span> <span class=o>=</span> <span class=nx>originalGetWinner</span><span class=p>;</span> <span class=c1>// cleanup
</span></span></span></code></pre></td></tr></table></div></div><blockquote class=danger-callout><p>In ES modules monkey patching does not work.</p></blockquote><a href=#cleanup><h3 id=cleanup><span class=hanchor arialabel=Anchor># </span>Cleanup</h3></a><p>Important thing in testing is to clean up after the mocking in the test case, so the other cases may use the original module again or mock it in a different way.</p><p>In this test case we reassign the real function, exported from the <code>utils.ts</code> back to <code>getWinner</code>.</p><a href=#ensuring-fns-are-called-properly-with-mocks><h2 id=ensuring-fns-are-called-properly-with-mocks><span class=hanchor arialabel=Anchor># </span>Ensuring fns are called properly with mocks</h2></a><p>When writing tests and mocking dependencies, we want to verify that the function was called correctly, by tracking how often the function was called and what arguments it was called with. This is to ensure the usage of <code>utils.getWinner</code> in <code>thumbWar</code> implementation is correct.</p><p>To do that we may use <code>jest.fn</code> <em>mock function</em>. It keeps track the parameters and how many it was called.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=nx>utils</span><span class=p>.</span><span class=nx>getWinner</span> <span class=o>=</span> <span class=nx>jest</span><span class=p>.</span><span class=nx>fn</span><span class=p>((</span><span class=nx>p1</span><span class=p>,</span> <span class=nx>p2</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>p1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>expect</span><span class=p>(</span><span class=nx>utils</span><span class=p>.</span><span class=nx>getWinner</span><span class=p>).</span><span class=nx>toHaveBeenCalledTimes</span><span class=p>(</span><span class=mi>2</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>expect</span><span class=p>(</span><span class=nx>utils</span><span class=p>.</span><span class=nx>getWinner</span><span class=p>).</span><span class=nx>toHaveBeenCalledWith</span><span class=p>(</span><span class=s2>&#34;Kent C. Dodds&#34;</span><span class=p>,</span> <span class=s2>&#34;Ken Wheeler&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>expect</span><span class=p>(</span><span class=nx>utils</span><span class=p>.</span><span class=nx>getWinner</span><span class=p>).</span><span class=nx>toHaveBeenNthCalledWith</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=mi>1</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;Kent C. Dodds&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;Ken Wheeler&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span><span class=line><span class=cl><span class=nx>expect</span><span class=p>(</span><span class=nx>utils</span><span class=p>.</span><span class=nx>getWinner</span><span class=p>).</span><span class=nx>toHaveBeenNthCalledWith</span><span class=p>(</span>
</span></span><span class=line><span class=cl>  <span class=mi>2</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;Kent C. Dodds&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=s2>&#34;Ken Wheeler&#34;</span><span class=p>,</span>
</span></span><span class=line><span class=cl><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><a href=#jestfn><h2 id=jestfn><span class=hanchor arialabel=Anchor># </span><code>jest.fn</code></h2></a><p><code>jest.fn</code> internally is a function that has some nice properties for use:</p><ul><li><code>mock</code><ul><li><code>calls</code> - an array that holds all of the args that the function was called with</li></ul></li></ul><p>Last 3 assertions could be rewritten as one:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=nx>expect</span><span class=p>(</span><span class=nx>utils</span><span class=p>.</span><span class=nx>getWinner</span><span class=p>.</span><span class=nx>mock</span><span class=p>.</span><span class=nx>calls</span><span class=p>).</span><span class=nx>toEqual</span><span class=p>([</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=s2>&#34;Kent C. Dodds&#34;</span><span class=p>,</span> <span class=s2>&#34;Ken Wheeler&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl>  <span class=p>[</span><span class=s2>&#34;Kent C. Dodds&#34;</span><span class=p>,</span> <span class=s2>&#34;Ken Wheeler&#34;</span><span class=p>],</span>
</span></span><span class=line><span class=cl><span class=p>]);</span>
</span></span></code></pre></td></tr></table></div></div><p>This could be implemented this way:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>type</span> <span class=nx>MockFnType</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>mock</span><span class=o>:</span> <span class=p>{</span> <span class=nx>calls</span>: <span class=kt>any</span><span class=p>[]</span> <span class=p>}</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>fn</span><span class=p>(</span><span class=nx>impl</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>mockFn</span>: <span class=kt>MockFnType</span> <span class=o>=</span> <span class=p>(...</span><span class=nx>args</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>mockFn</span><span class=p>.</span><span class=nx>mock</span><span class=p>.</span><span class=nx>calls</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>impl</span><span class=p>(</span><span class=nx>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>mockFn</span><span class=p>.</span><span class=nx>mock</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>calls</span><span class=o>:</span> <span class=p>[]</span> <span class=p>};</span> <span class=c1>// this implementation saves each call in the array
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=nx>mockFn</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// usage
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>utils</span><span class=p>.</span><span class=nx>getWinner</span> <span class=o>=</span> <span class=nx>fn</span><span class=p>((</span><span class=nx>p1</span><span class=p>,</span> <span class=nx>p2</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>p1</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><a href=#jestspyon><h2 id=jestspyon><span class=hanchor arialabel=Anchor># </span><code>jest.spyOn</code></h2></a><p>We can use <code>jest.spyOn</code> to avoid keeping track of the original implementation (<code>const originalGetWinner = utils.getWinner</code>) and cleaning up after the test case (<code>utils.getWinner = originalGetWinner</code>) on our own.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=nx>jest</span><span class=p>.</span><span class=nx>spyOn</span><span class=p>(</span><span class=nx>utils</span><span class=p>,</span> <span class=s2>&#34;getWinner&#34;</span><span class=p>);</span> <span class=c1>// spying on the original implementation
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>utils</span><span class=p>.</span><span class=nx>getWinner</span><span class=p>.</span><span class=nx>mockImplementation</span><span class=p>((</span><span class=nx>p1</span><span class=p>,</span> <span class=nx>p2</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>p2</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=nx>utils</span><span class=p>.</span><span class=nx>getWinner</span><span class=p>.</span><span class=nx>mockRestore</span><span class=p>();</span> <span class=c1>// cleanup
</span></span></span></code></pre></td></tr></table></div></div><p>This could be implemented this way:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>type</span> <span class=nx>MockFnType</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>mock</span><span class=o>:</span> <span class=p>{</span> <span class=nx>calls</span>: <span class=kt>any</span><span class=p>[]</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>mockImplementation</span><span class=o>:</span> <span class=p>(</span><span class=kt>any</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=kt>any</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>fn</span><span class=p>(</span><span class=nx>impl</span> <span class=o>=</span> <span class=p>(</span><span class=nx>args</span>: <span class=kt>any</span><span class=p>[])</span> <span class=o>=&gt;</span> <span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>mockFn</span>: <span class=kt>MockFnType</span> <span class=o>=</span> <span class=p>(...</span><span class=nx>args</span>: <span class=kt>any</span><span class=p>[])</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>mockFn</span><span class=p>.</span><span class=nx>mock</span><span class=p>.</span><span class=nx>calls</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>impl</span><span class=p>(</span><span class=nx>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>mockFn</span><span class=p>.</span><span class=nx>mock</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>calls</span><span class=o>:</span> <span class=p>[]</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>mockFn</span><span class=p>.</span><span class=nx>mockImplementation</span> <span class=o>=</span> <span class=p>(</span><span class=nx>newImpl</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=nx>impl</span> <span class=o>=</span> <span class=nx>newImpl</span><span class=p>);</span> <span class=c1>// saving the mocked implementation
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=nx>mockFn</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>spyOn</span><span class=p>(</span><span class=nx>obj</span>: <span class=kt>any</span><span class=p>,</span> <span class=nx>property</span>: <span class=kt>string</span><span class=p>)</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>originalProperty</span> <span class=o>=</span> <span class=nx>obj</span><span class=p>[</span><span class=nx>property</span><span class=p>];</span> <span class=c1>// track original value, function
</span></span></span><span class=line><span class=cl><span class=c1></span>
</span></span><span class=line><span class=cl>  <span class=nx>obj</span><span class=p>[</span><span class=nx>property</span><span class=p>]</span> <span class=o>=</span> <span class=nx>fn</span><span class=p>();</span>
</span></span><span class=line><span class=cl>  <span class=nx>obj</span><span class=p>[</span><span class=nx>property</span><span class=p>].</span><span class=nx>mockRestore</span> <span class=o>=</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=nx>obj</span><span class=p>[</span><span class=nx>property</span><span class=p>]</span> <span class=o>=</span> <span class=nx>originalProperty</span><span class=p>);</span> <span class=c1>// adding a way to &#34;release the mock&#34;
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=p>}</span>
</span></span></code></pre></td></tr></table></div></div><p>Up to this point we still were doing something only just slightly more sophisticated to <a class="internal-link broken">monkey patching</a>. It works only because we&rsquo;re using CommonJS. In ES modules monkey patching does not work.</p><a href=#jestmock><h2 id=jestmock><span class=hanchor arialabel=Anchor># </span><code>jest.mock</code></h2></a><p><code>jest.mock</code> returns a mocked implementation of a whole module.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span><span class=lnt>5
</span><span class=lnt>6
</span><span class=lnt>7
</span><span class=lnt>8
</span><span class=lnt>9
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=nx>jest</span><span class=p>.</span><span class=nx>mock</span><span class=p>(</span><span class=s1>&#39;../utils&#39;</span><span class=p>,</span> <span class=p>()</span> <span class=o>=&gt;</span> <span class=p>{</span> <span class=c1>// first arg: relative path to the mocked module
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=c1>// second arg: module factory function
</span></span></span><span class=line><span class=cl><span class=c1></span>  <span class=k>return</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>      <span class=nx>getWinner</span>: <span class=kt>jest.fn</span><span class=p>((</span><span class=nx>p1</span><span class=p>,</span> <span class=nx>p2</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>p1</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>}</span>
</span></span><span class=line><span class=cl><span class=p>});</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// cleanup
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=nx>utils</span><span class=p>.</span><span class=nx>getWinner</span><span class=p>.</span><span class=nx>mockReset</span><span class=p>();</span>
</span></span></code></pre></td></tr></table></div></div><p><code>.mockReset()</code> will¬†reset our mock function to the initial state clearing out the <code>calls</code>.</p><p><code>jest.mock</code> works, because Jest is in control of the whole module system.</p><blockquote class=tip-callout><p>Jest hoists the <code>jest.mock</code> call to the top of the file, before imports.</p><p>We don&rsquo;t have to do it manually.</p></blockquote><p>This is how we can implement it on our own by using <code>require.cache</code>.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt> 1
</span><span class=lnt> 2
</span><span class=lnt> 3
</span><span class=lnt> 4
</span><span class=lnt> 5
</span><span class=lnt> 6
</span><span class=lnt> 7
</span><span class=lnt> 8
</span><span class=lnt> 9
</span><span class=lnt>10
</span><span class=lnt>11
</span><span class=lnt>12
</span><span class=lnt>13
</span><span class=lnt>14
</span><span class=lnt>15
</span><span class=lnt>16
</span><span class=lnt>17
</span><span class=lnt>18
</span><span class=lnt>19
</span><span class=lnt>20
</span><span class=lnt>21
</span><span class=lnt>22
</span><span class=lnt>23
</span><span class=lnt>24
</span><span class=lnt>25
</span><span class=lnt>26
</span><span class=lnt>27
</span><span class=lnt>28
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=kr>const</span> <span class=nx>utilsPath</span> <span class=o>=</span> <span class=kr>require</span><span class=p>.</span><span class=nx>resolve</span><span class=p>(</span><span class=s2>&#34;../utils&#34;</span><span class=p>);</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kr>type</span> <span class=nx>MockFnType</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>mock</span><span class=o>:</span> <span class=p>{</span> <span class=nx>calls</span>: <span class=kt>any</span><span class=p>[]</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>mockImplementation</span><span class=o>:</span> <span class=p>(</span><span class=kt>any</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=kt>any</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=kd>function</span> <span class=nx>fn</span><span class=p>(</span><span class=nx>impl</span> <span class=o>=</span> <span class=p>(...</span><span class=nx>args</span>: <span class=kt>any</span><span class=p>[])</span> <span class=o>=&gt;</span> <span class=p>{})</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=kr>const</span> <span class=nx>mockFn</span>: <span class=kt>MockFnType</span> <span class=o>=</span> <span class=p>(...</span><span class=nx>args</span>: <span class=kt>any</span><span class=p>[])</span> <span class=o>=&gt;</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>mockFn</span><span class=p>.</span><span class=nx>mock</span><span class=p>.</span><span class=nx>calls</span><span class=p>.</span><span class=nx>push</span><span class=p>(</span><span class=nx>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>    <span class=k>return</span> <span class=nx>impl</span><span class=p>(...</span><span class=nx>args</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>mockFn</span><span class=p>.</span><span class=nx>mock</span> <span class=o>=</span> <span class=p>{</span> <span class=nx>calls</span><span class=o>:</span> <span class=p>[]</span> <span class=p>};</span>
</span></span><span class=line><span class=cl>  <span class=nx>mockFn</span><span class=p>.</span><span class=nx>mockImplementation</span> <span class=o>=</span> <span class=p>(</span><span class=nx>newImpl</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=p>(</span><span class=nx>impl</span> <span class=o>=</span> <span class=nx>newImpl</span><span class=p>);</span>
</span></span><span class=line><span class=cl>  <span class=k>return</span> <span class=nx>mockFn</span><span class=p>;</span>
</span></span><span class=line><span class=cl><span class=p>}</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=c1>// @ts-ignore missing properties
</span></span></span><span class=line><span class=cl><span class=c1></span><span class=kr>require</span><span class=p>.</span><span class=nx>cache</span><span class=p>[</span><span class=nx>utilsPath</span><span class=p>]</span> <span class=o>=</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>  <span class=nx>id</span>: <span class=kt>utilsPath</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>filename</span>: <span class=kt>utilsPath</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>loaded</span>: <span class=kt>true</span><span class=p>,</span>
</span></span><span class=line><span class=cl>  <span class=nx>exports</span><span class=o>:</span> <span class=p>{</span>
</span></span><span class=line><span class=cl>    <span class=nx>getWinner</span>: <span class=kt>fn</span><span class=p>((</span><span class=nx>p1</span><span class=p>,</span> <span class=nx>p2</span><span class=p>)</span> <span class=o>=&gt;</span> <span class=nx>p1</span><span class=p>),</span>
</span></span><span class=line><span class=cl>  <span class=p>},</span>
</span></span><span class=line><span class=cl><span class=p>};</span>
</span></span><span class=line><span class=cl>
</span></span><span class=line><span class=cl><span class=k>delete</span> <span class=kr>require</span><span class=p>.</span><span class=nx>cache</span><span class=p>[</span><span class=nx>utilsPath</span><span class=p>];</span> <span class=c1>// cleanup
</span></span></span></code></pre></td></tr></table></div></div><p>This is something similar, yet simplified version of what Jest is doing.</p><a href=#mocking-a-module-shared-across-the-codebase><h2 id=mocking-a-module-shared-across-the-codebase><span class=hanchor arialabel=Anchor># </span>Mocking a module shared across the codebase</h2></a><p>Use <code>__mocks__</code> directory.</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span><span class=lnt>2
</span><span class=lnt>3
</span><span class=lnt>4
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-sh data-lang=sh><span class=line><span class=cl>$ tree
</span></span><span class=line><span class=cl>‚îú‚îÄ‚îÄ __mocks__
</span></span><span class=line><span class=cl>‚îÇ   ‚îî‚îÄ‚îÄ utils.ts
</span></span><span class=line><span class=cl>‚îî‚îÄ‚îÄ utils.ts
</span></span></code></pre></td></tr></table></div></div><p>Then in test file:</p><div class=highlight><div class=chroma><table class=lntable><tr><td class=lntd><pre tabindex=0 class=chroma><code><span class=lnt>1
</span></code></pre></td><td class=lntd><pre tabindex=0 class=chroma><code class=language-ts data-lang=ts><span class=line><span class=cl><span class=nx>jest</span><span class=p>.</span><span class=nx>mock</span><span class=p>(</span><span class=s2>&#34;../utils&#34;</span><span class=p>);</span>
</span></span></code></pre></td></tr></table></div></div><p><code>jest</code> knows to pick up the path from <strong>mocks</strong> directory.</p></article><hr><div class=directories><h3>index<span>_</span></h3><div class=items><div class=item><a href=https://koscielniak.pro/development/testing-javascript/fundamentals/ class=file data-src=/development/testing-javascript/fundamentals/>Testing Fundamentals/</a></div><div class=item><a href=https://koscielniak.pro/development/testing-javascript/mocking/ class=file data-src=/development/testing-javascript/mocking/>Mocking.md</a></div><div class=item><a href=https://koscielniak.pro/development/testing-javascript/static-analysis/ class=file data-src=/development/testing-javascript/static-analysis/>Static Analysis.md</a></div><div class=item><a href=https://koscielniak.pro/development/testing-javascript/configuring-jest/ class=file data-src=/development/testing-javascript/configuring-jest/>Configuring Jest/</a></div><div class=item><a href=https://koscielniak.pro/development/testing-javascript/jest/ class=file data-src=/development/testing-javascript/jest/>Testing with Jest/</a></div><div class=item><a href=https://koscielniak.pro/development/testing-javascript/cypress/ class=file data-src=/development/testing-javascript/cypress/>Testing with Cypress/</a></div></div></div><div class=page-end id=footer><div class=backlinks-container><h3>backlinks_</h3><ul class=backlinks><li>No backlinks found</li></ul></div><div><script src=https://cdn.jsdelivr.net/npm/d3@6.7.0/dist/d3.min.js integrity="sha256-+7jaYCp29O1JusNWHaYtgUn6EhuP0VaFuswhNV06MyI=" crossorigin=anonymous></script><h3>knowledge graph_</h3><div id=graph-container></div><style>:root{--g-node:var(--secondary);--g-node-active:var(--primary);--g-node-inactive:var(--visited);--g-link:var(--outlinegray);--g-link-active:#5a7282}</style><script src=https://koscielniak.pro/js/graph.abd4bc2af3869a96524d7d23b76152c7.js></script></div></div><div id=contact_buttons><footer><p>crafted by kkoscielniak. built using <a href=https://github.com/jackyzha0/quartz>quartz</a></p><ul><li><a href=https://koscielniak.pro>Home</a></li><li><a href=https://instagram.com/pankoscielniak>insta</a></li><li><a href=https://github.com/kkoscielniak>github</a></li></ul></footer></div></div></body></html>